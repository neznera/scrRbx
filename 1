--[[
    ESP (жёлтые рамки) + Aimbot (автоматически на голову, без удержания, большой FOV)
    - ESP: рамки на все BasePart врагов (обновляются каждый кадр).
    - Aimbot: постоянно наводит мышь на голову ближайшего врага в FOV.
    - Настройки: TeamCheck, FOV (можно менять ниже).
]]

local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local CoreGui = (gethui and gethui()) or game:GetService("CoreGui")
local workspace = game:GetService("Workspace")

if syn and syn.protect_gui then syn.protect_gui(CoreGui) elseif protect_gui then protect_gui(CoreGui) end

local LocalPlayer = Players.LocalPlayer
local Camera = workspace.CurrentCamera

-- ===== НАСТРОЙКИ (меняй здесь) =====
local Settings = {
    -- ESP
    ESP_Enabled = true,

    -- Aimbot
    Aimbot_Enabled = true,      -- true = аим всегда активен
    TeamCheck = true,           -- true = не целиться в союзников
    FOV = 2000,                 -- радиус в пикселях на экране (2000 покрывает почти весь экран)
    AimAtHead = true,           -- true = целиться в голову, false = в корпус (запасной вариант)
}

-- ===== ПЕРЕМЕННЫЕ =====
local ESP_Folder = Instance.new("Folder")
ESP_Folder.Name = "ESP_Container"
ESP_Folder.Parent = CoreGui

-- ===== ФУНКЦИЯ ДВИЖЕНИЯ МЫШИ =====
local function MoveMouse(targetX, targetY)
    local current = UserInputService:GetMouseLocation()
    local deltaX, deltaY = targetX - current.X, targetY - current.Y
    if math.abs(deltaX) < 0.5 and math.abs(deltaY) < 0.5 then return end

    if mousemoverel then
        mousemoverel(deltaX, deltaY)
    elseif syn and syn.input then
        syn.input.MouseMove(deltaX, deltaY)
    elseif VirtualInputManager then
        VirtualInputManager:SendMouseMoveEvent(deltaX, deltaY, false)
    end
end

-- ===== ПРОВЕРКА ВРАГ =====
local function IsEnemy(player)
    if player == LocalPlayer then return false end
    if Settings.TeamCheck then
        if not player.Team or not LocalPlayer.Team then return true end
        return player.Team ~= LocalPlayer.Team
    end
    return true
end

-- ===== ESP (ПЕРЕСОЗДАНИЕ КАЖДЫЙ КАДР) =====
local function UpdateESP()
    -- Удаляем все старые рамки
    for _, child in pairs(ESP_Folder:GetChildren()) do
        child:Destroy()
    end

    if not Settings.ESP_Enabled then return end

    for _, player in pairs(Players:GetPlayers()) do
        if IsEnemy(player) then
            local char = player.Character
            if char then
                local hum = char:FindFirstChild("Humanoid")
                if hum and hum.Health > 0 then
                    for _, part in pairs(char:GetDescendants()) do
                        if part:IsA("BasePart") and part.Transparency < 1 then
                            local box = Instance.new("BoxHandleAdornment")
                            box.Name = part.Name
                            box.Adornee = part
                            box.AlwaysOnTop = true
                            box.ZIndex = 10
                            box.Size = part.Size * 1.05
                            box.Transparency = 0.3
                            box.Color = BrickColor.new("Bright yellow")
                            box.Parent = ESP_Folder
                        end
                    end
                end
            end
        end
    end
end

-- ===== ПОИСК ЦЕЛИ (ближайший враг в FOV) =====
local function GetClosestEnemyInFOV()
    local mousePos = UserInputService:GetMouseLocation()
    local closestPlayer = nil
    local closestDist = Settings.FOV

    for _, player in pairs(Players:GetPlayers()) do
        if IsEnemy(player) then
            local char = player.Character
            if char then
                local hum = char:FindFirstChild("Humanoid")
                if hum and hum.Health > 0 then
                    -- Определяем целевую часть
                    local targetPart
                    if Settings.AimAtHead then
                        targetPart = char:FindFirstChild("Head")  -- сначала голова
                    end
                    if not targetPart then  -- если головы нет или AimAtHead = false
                        targetPart = char:FindFirstChild("HumanoidRootPart") or
                                     char:FindFirstChild("Torso") or
                                     char:FindFirstChild("UpperTorso") or
                                     char:FindFirstChild("Head")  -- на всякий случай
                    end

                    if targetPart then
                        local vec, onScreen = Camera:WorldToViewportPoint(targetPart.Position)
                        if onScreen then
                            local dist = (Vector2.new(vec.X, vec.Y) - Vector2.new(mousePos.X, mousePos.Y)).Magnitude
                            if dist < closestDist then
                                closestDist = dist
                                closestPlayer = {player = player, targetPart = targetPart}
                            end
                        end
                    end
                end
            end
        end
    end
    return closestPlayer
end

-- ===== НАВЕДЕНИЕ =====
local function AimAtTarget(targetPart)
    if not targetPart then return end
    local vec, onScreen = Camera:WorldToViewportPoint(targetPart.Position)
    if onScreen then
        MoveMouse(vec.X, vec.Y)
    end
end

-- ===== ГЛАВНЫЙ ЦИКЛ (работает постоянно) =====
RunService.RenderStepped:Connect(function()
    -- Обновляем ESP
    UpdateESP()

    -- Аим всегда активен (без удержания кнопки)
    if Settings.Aimbot_Enabled then
        local targetData = GetClosestEnemyInFOV()
        if targetData and targetData.targetPart then
            AimAtTarget(targetData.targetPart)
        end
    end
end)

print("✅ Автоматический Aimbot (голова) + ESP загружены. TeamCheck = " .. tostring(Settings.TeamCheck) .. ", FOV = " .. Settings.FOV)
