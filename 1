local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local CoreGui = (gethui and gethui()) or game:GetService("CoreGui")

-- Защита CoreGui
if syn and syn.protect_gui then
    syn.protect_gui(CoreGui)
elseif protect_gui then
    protect_gui(CoreGui)
end

local LocalPlayer = Players.LocalPlayer
local Camera = workspace.CurrentCamera

-- ========== ПРОВЕРКА ПОДДЕРЖКИ DRAWING ==========
local DrawingSupported = pcall(Drawing.new, "Square")

-- ========== УНИВЕРСАЛЬНОЕ УПРАВЛЕНИЕ МЫШЬЮ ==========
local function MoveMouse(deltaX, deltaY)
    if mousemoverel then
        mousemoverel(deltaX, deltaY)
        return true
    elseif syn and syn.input then
        syn.input.MouseMove(deltaX, deltaY)
        return true
    elseif VirtualInputManager then
        VirtualInputManager:SendMouseMoveEvent(deltaX, deltaY, false)
        return true
    end
    return false
end

local function ClickMouse()
    if mouse1click then
        mouse1click()
        return true
    elseif syn and syn.input then
        syn.input.Mouse1Click()
        return true
    elseif VirtualInputManager then
        VirtualInputManager:SendMouseButtonEvent(0, 0, 0, true, nil, 0)
        VirtualInputManager:SendMouseButtonEvent(0, 0, 0, false, nil, 0)
        return true
    end
    return false
end

-- ========== СЛУЧАЙНЫЕ ИМЕНА ==========
local function randomString(len)
    local str = ""
    for i = 1, len do
        str = str .. string.char(math.random(65, 90))
    end
    return str
end

-- ========== НАСТРОЙКИ ==========
local Settings = {
    -- ESP
    ESP_Enabled = true,
    ESP_Transparency = 0.4,
    ESP_Color = Color3.fromRGB(255, 255, 0),  -- жёлтый

    -- Aimbot
    Aimbot_Enabled = true,
    Aimbot_Key = Enum.UserInputType.MouseButton2,
    Aimbot_TargetMode = "3D",           -- "3D" или "FOV"
    Aimbot_FOV = 120,
    Aimbot_TeamCheck = true,
    Aimbot_Wallbang = false,
    Aimbot_NoRecoil = true,
    Aimbot_RapidFire = true,
    Aimbot_RapidFireDelay = 0.06,
    Aimbot_AutoFire = true,
    Aimbot_SilentAim = false,

    -- Fast Bullets
    FastBullets_Enabled = true,
    FastBullets_Multiplier = 5,
}

-- ========== ПЕРЕМЕННЫЕ ==========
local ESP_3D_Cache = setmetatable({}, {__mode = "v"})  -- для 3D боксов
local ESP_2D_Cache = {}                               -- для Drawing боксов (части)
local IsKeyHolding = false
local AimTarget = nil
local LastShotTime = 0
local LastTargetUpdate = 0
local TARGET_UPDATE_RATE = 0.15
local MenuOpen = true
local Dragging = false
local DragStart, DragPos
local LastRecoilReset = 0
local LastFastBulletApply = 0

-- ========== FAST BULLETS (УСКОРЕНИЕ ПУЛЬ) ==========
local function ApplyFastBullets()
    if not Settings.FastBullets_Enabled then return end
    local now = tick()
    if now - LastFastBulletApply < 0.2 then return end  -- не спамим

    local character = LocalPlayer.Character
    if not character then return end
    local tool = character:FindFirstChildOfClass("Tool") or character:FindFirstChildWhichIsA("Tool")
    if not tool then return end

    local velocityProps = {
        "BulletVelocity", "Velocity", "ProjectileVelocity", "Speed",
        "BulletSpeed", "LaunchSpeed", "ShotVelocity", "MaxSpeed", "ProjectileSpeed"
    }

    for _, propName in ipairs(velocityProps) do
        pcall(function()
            -- Прямое свойство
            if tool[propName] ~= nil then
                if type(tool[propName]) == "number" then
                    tool[propName] = tool[propName] * Settings.FastBullets_Multiplier
                elseif tool[propName]:IsA("NumberValue") then
                    tool[propName].Value = tool[propName].Value * Settings.FastBullets_Multiplier
                end
            end
            -- В дочерних объектах
            for _, child in pairs(tool:GetDescendants()) do
                if child:IsA("Part") or child:IsA("MeshPart") then
                    if child[propName] ~= nil then
                        if type(child[propName]) == "number" then
                            child[propName] = child[propName] * Settings.FastBullets_Multiplier
                        elseif child[propName]:IsA("NumberValue") then
                            child[propName].Value = child[propName].Value * Settings.FastBullets_Multiplier
                        end
                    end
                end
            end
        end)
    end
    LastFastBulletApply = now
end

-- ========== NO RECOIL ==========
local function ApplyNoRecoil()
    if not Settings.Aimbot_NoRecoil then return end
    local now = tick()
    if now - LastRecoilReset < 0.1 then return end

    local character = LocalPlayer.Character
    if not character then return end
    local tool = character:FindFirstChildOfClass("Tool") or character:FindFirstChildWhichIsA("Tool")
    if tool then
        local recoilProps = {"Recoil", "Bloom", "Spread", "Deviation", "CameraRecoil", "RecoilMax", "RecoilMin", "Shake", "Sway"}
        for _, prop in ipairs(recoilProps) do
            pcall(function()
                if tool:FindFirstChild(prop) then
                    tool[prop].Value = 0
                end
                if tool[prop] ~= nil then
                    tool[prop] = 0
                end
            end)
        end
    end
    LastRecoilReset = now
end

-- ========== ESP (2D DRAWING) НА ВСЕ ЧАСТИ ==========
if DrawingSupported then
    -- Очистка при выходе игрока
    Players.PlayerRemoving:Connect(function(p)
        if ESP_2D_Cache[p] then
            for _, box in pairs(ESP_2D_Cache[p]) do
                box:Remove()
            end
            ESP_2D_Cache[p] = nil
        end
    end)

    local function UpdateDrawingESP()
        if not Settings.ESP_Enabled then
            for _, boxes in pairs(ESP_2D_Cache) do
                for _, box in pairs(boxes) do
                    box.Visible = false
                end
            end
            return
        end

        for _, p in pairs(Players:GetPlayers()) do
            if p ~= LocalPlayer and p.Character and p.Character:FindFirstChild("Humanoid") and p.Character.Humanoid.Health > 0 then
                local char = p.Character
                local parts = {}
                -- Собираем все видимые части
                for _, part in pairs(char:GetChildren()) do
                    if part:IsA("BasePart") and part.Transparency < 1 then
                        table.insert(parts, part)
                    end
                end

                -- Создаём или обновляем боксы для каждой части
                if not ESP_2D_Cache[p] then
                    ESP_2D_Cache[p] = {}
                end
                local boxes = ESP_2D_Cache[p]

                -- Делаем все боксы невидимыми, потом покажем нужные
                for _, box in pairs(boxes) do
                    box.Visible = false
                end

                for i, part in ipairs(parts) do
                    local pos, onScreen = Camera:WorldToViewportPoint(part.Position)
                    if onScreen then
                        -- Размер бокса пропорционален размеру части и расстоянию
                        local dist = (Camera.CFrame.Position - part.Position).Magnitude
                        local scale = math.clamp(300 / dist, 0.5, 2)
                        local width = part.Size.X * 40 * scale
                        local height = part.Size.Y * 40 * scale
                        local x = pos.X - width/2
                        local y = pos.Y - height/2

                        if not boxes[i] then
                            boxes[i] = Drawing.new("Square")
                            boxes[i].Thickness = 2
                            boxes[i].Filled = false
                            boxes[i].ZIndex = 5
                        end
                        local box = boxes[i]
                        box.Visible = true
                        box.Size = Vector2.new(width, height)
                        box.Position = Vector2.new(x, y)
                        box.Color = Settings.ESP_Color
                        box.Transparency = Settings.ESP_Transparency
                    end
                end
            else
                if ESP_2D_Cache[p] then
                    for _, box in pairs(ESP_2D_Cache[p]) do
                        box.Visible = false
                    end
                end
            end
        end
    end

    RunService.RenderStepped:Connect(UpdateDrawingESP)
else
    -- ========== ESP (3D) НА ВСЕ ЧАСТИ ==========
    print("⚠️ Drawing не поддерживается, использую 3D боксы на каждую часть")
    local ESP_Folder = Instance.new("Folder")
    ESP_Folder.Name = "ESP_" .. randomString(6)
    ESP_Folder.Parent = CoreGui

    function CreateESP(p)
        if not Settings.ESP_Enabled then return end
        local char = p.Character
        if not char then return end
        local hum = char:FindFirstChild("Humanoid")
        if not hum or hum.Health <= 0 then return end

        local container = Instance.new("Folder")
        container.Name = randomString(12)
        container.Parent = ESP_Folder
        if syn and syn.protect_gui then syn.protect_gui(container) elseif protect_gui then protect_gui(container) end

        local adornments = {}
        local function addBoxes()
            for _, part in pairs(char:GetChildren()) do
                if part:IsA("BasePart") and part.Transparency < 1 then
                    local box = Instance.new("BoxHandleAdornment")
                    box.Name = randomString(8)
                    box.Adornee = part
                    box.AlwaysOnTop = true
                    box.ZIndex = 10
                    box.Size = part.Size * 1.1
                    box.Transparency = Settings.ESP_Transparency
                    box.Color = BrickColor.new(Settings.ESP_Color)
                    box.Parent = container
                    adornments[part] = box
                end
            end
        end
        addBoxes()

        local connection
        connection = char.ChildAdded:Connect(function(child)
            if child:IsA("BasePart") and child.Transparency < 1 then
                local box = Instance.new("BoxHandleAdornment")
                box.Name = randomString(8)
                box.Adornee = child
                box.AlwaysOnTop = true
                box.ZIndex = 10
                box.Size = child.Size * 1.1
                box.Transparency = Settings.ESP_Transparency
                box.Color = BrickColor.new(Settings.ESP_Color)
                box.Parent = container
                adornments[child] = box
            end
        end)

        ESP_3D_Cache[p] = {
            Container = container,
            Connections = {connection},
        }
    end

    function RemoveESP(p)
        if ESP_3D_Cache[p] then
            for _, conn in pairs(ESP_3D_Cache[p].Connections) do conn:Disconnect() end
            if ESP_3D_Cache[p].Container then ESP_3D_Cache[p].Container:Destroy() end
            ESP_3D_Cache[p] = nil
        end
    end

    function RefreshAllESP()
        for p, _ in pairs(ESP_3D_Cache) do RemoveESP(p) end
        for _, p in pairs(Players:GetPlayers()) do
            if p ~= LocalPlayer then CreateESP(p) end
        end
    end

    function UpdateESPTransparency()
        for p, data in pairs(ESP_3D_Cache) do
            if data.Container then
                for _, child in pairs(data.Container:GetChildren()) do
                    if child:IsA("BoxHandleAdornment") then
                        child.Transparency = Settings.ESP_Transparency
                    end
                end
            end
        end
    end

    local function onCharacterAdded(p, char)
        if p == LocalPlayer then return end
        RemoveESP(p)
        CreateESP(p)
    end

    for _, p in pairs(Players:GetPlayers()) do
        if p ~= LocalPlayer then
            if p.Character then CreateESP(p) end
            p.CharacterAdded:Connect(function(char) onCharacterAdded(p, char) end)
            p.CharacterRemoving:Connect(function() RemoveESP(p) end)
        end
    end

    Players.PlayerAdded:Connect(function(p)
        if p == LocalPlayer then return end
        p.CharacterAdded:Connect(function(char) onCharacterAdded(p, char) end)
        p.CharacterRemoving:Connect(function() RemoveESP(p) end)
    end)

    Players.PlayerRemoving:Connect(RemoveESP)
end

-- ========== AIMBOT LOGIC ==========
local function IsTeamMate(p)
    if not Settings.Aimbot_TeamCheck then return false end
    if not p.Team or not LocalPlayer.Team then return false end
    return p.Team == LocalPlayer.Team
end

local function IsVisible(character)
    if Settings.Aimbot_Wallbang then return true end
    local head = character:FindFirstChild("Head")
    if not head then return false end
    local origin = Camera.CFrame.Position
    local direction = head.Position - origin
    local ray = Ray.new(origin, direction.Unit * direction.Magnitude)
    local hit = workspace:FindPartOnRayWithIgnoreList(ray, {LocalPlayer.Character, Camera})
    return hit and hit:IsDescendantOf(character)
end

local function GetTarget()
    if not Settings.Aimbot_Enabled then return nil end

    local targets = {}
    local myHead = LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("Head")
    local mousePos = UserInputService:GetMouseLocation()

    for _, p in pairs(Players:GetPlayers()) do
        if p ~= LocalPlayer and p.Character and p.Character:FindFirstChild("Humanoid") and p.Character.Humanoid.Health > 0 then
            if not IsTeamMate(p) and IsVisible(p.Character) then
                local head = p.Character:FindFirstChild("Head")
                if head then
                    local dist3D = myHead and (head.Position - myHead.Position).Magnitude or math.huge
                    local vector, onScreen = Camera:WorldToViewportPoint(head.Position)
                    if onScreen then
                        local dist2D = (Vector2.new(vector.X, vector.Y) - mousePos).Magnitude
                        table.insert(targets, {
                            player = p,
                            head = head,
                            dist3D = dist3D,
                            dist2D = dist2D,
                        })
                    end
                end
            end
        end
    end

    if #targets == 0 then return nil end

    if Settings.Aimbot_TargetMode == "FOV" then
        local best = nil
        local bestDist = Settings.Aimbot_FOV
        for _, t in ipairs(targets) do
            if t.dist2D < bestDist then
                bestDist = t.dist2D
                best = t.player
            end
        end
        return best
    else
        table.sort(targets, function(a,b) return a.dist3D < b.dist3D end)
        return targets[1].player
    end
end

-- ========== УПРАВЛЕНИЕ КЛАВИШЕЙ ==========
UserInputService.InputBegan:Connect(function(input, gp)
    if not gp and input.UserInputType == Settings.Aimbot_Key then
        IsKeyHolding = true
    end
end)

UserInputService.InputEnded:Connect(function(input)
    if input.UserInputType == Settings.Aimbot_Key then
        IsKeyHolding = false
        AimTarget = nil
    end
end)

-- ========== ГЛАВНЫЙ ЦИКЛ ==========
RunService.RenderStepped:Connect(function()
    -- Fast Bullets
    ApplyFastBullets()
    -- No Recoil
    ApplyNoRecoil()

    local now = tick()

    -- Обновление цели
    if Settings.Aimbot_Enabled and IsKeyHolding then
        if now - LastTargetUpdate >= TARGET_UPDATE_RATE then
            AimTarget = GetTarget()
            LastTargetUpdate = now
        end
    else
        AimTarget = nil
    end

    -- Наведение и стрельба
    if AimTarget and AimTarget.Character and AimTarget.Character:FindFirstChild("Head") then
        local head = AimTarget.Character.Head
        local vector, onScreen = Camera:WorldToViewportPoint(head.Position)
        if onScreen then
            local targetPos = Vector2.new(vector.X, vector.Y)

            -- Move mouse (если не Silent Aim)
            if not Settings.Aimbot_SilentAim then
                local currentPos = UserInputService:GetMouseLocation()
                local delta = targetPos - currentPos
                if delta.Magnitude > 0.5 then
                    MoveMouse(delta.X, delta.Y)
                end
            end

            -- Auto Fire / Rapid Fire
            if Settings.Aimbot_AutoFire or Settings.Aimbot_RapidFire then
                if now - LastShotTime >= Settings.Aimbot_RapidFireDelay then
                    ClickMouse()
                    LastShotTime = now
                end
            end
        end
    end
end)

-- ========== МЕНЮ ==========
local function CreateMenu()
    local ScreenGui = Instance.new("ScreenGui")
    ScreenGui.Name = randomString(12)
    ScreenGui.Parent = CoreGui

    if syn and syn.protect_gui then
        syn.protect_gui(ScreenGui)
    elseif protect_gui then
        protect_gui(ScreenGui)
    end

    local MainFrame = Instance.new("Frame")
    MainFrame.Name = randomString(8)
    MainFrame.Size = UDim2.new(0, 280, 0, 650)
    MainFrame.Position = UDim2.new(0, 50, 0, 50)
    MainFrame.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
    MainFrame.BackgroundTransparency = 0.2
    MainFrame.Active = true
    MainFrame.Draggable = false
    MainFrame.Parent = ScreenGui

    local UICorner = Instance.new("UICorner")
    UICorner.CornerRadius = UDim.new(0, 6)
    UICorner.Parent = MainFrame

    local TopBar = Instance.new("Frame")
    TopBar.Size = UDim2.new(1, 0, 0, 30)
    TopBar.BackgroundColor3 = Color3.fromRGB(20, 20, 20)
    TopBar.BorderSizePixel = 0
    TopBar.Parent = MainFrame

    local TopBarCorner = Instance.new("UICorner")
    TopBarCorner.CornerRadius = UDim.new(0, 6)
    TopBarCorner.Parent = TopBar

    local Title = Instance.new("TextLabel")
    Title.Size = UDim2.new(1, -40, 1, 0)
    Title.Position = UDim2.new(0, 10, 0, 0)
    Title.BackgroundTransparency = 1
    Title.Text = "ESP + Aim God (FULL)"
    Title.TextColor3 = Color3.new(1, 1, 1)
    Title.TextXAlignment = Enum.TextXAlignment.Left
    Title.Font = Enum.Font.SourceSansBold
    Title.TextSize = 18
    Title.Parent = TopBar

    local CloseBtn = Instance.new("TextButton")
    CloseBtn.Size = UDim2.new(0, 30, 0, 30)
    CloseBtn.Position = UDim2.new(1, -30, 0, 0)
    CloseBtn.BackgroundTransparency = 1
    CloseBtn.Text = "X"
    CloseBtn.TextColor3 = Color3.new(1, 0, 0)
    CloseBtn.TextScaled = true
    CloseBtn.Font = Enum.Font.SourceSansBold
    CloseBtn.Parent = TopBar

    CloseBtn.MouseButton1Click:Connect(function()
        ScreenGui:Destroy()
        MenuOpen = false
    end)

    -- Перетаскивание
    TopBar.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 then
            Dragging = true
            DragStart = input.Position
            DragPos = MainFrame.Position
        end
    end)

    TopBar.InputChanged:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseMovement and Dragging then
            local delta = input.Position - DragStart
            MainFrame.Position = UDim2.new(DragPos.X.Scale, DragPos.X.Offset + delta.X, DragPos.Y.Scale, DragPos.Y.Offset + delta.Y)
        end
    end)

    UserInputService.InputEnded:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 then
            Dragging = false
        end
    end)

    -- ===== ВСПОМОГАТЕЛЬНЫЕ ФУНКЦИИ =====
    local yPos = 40

    local function CreateCheckbox(parent, text, yPos, getter, setter)
        local bg = Instance.new("Frame")
        bg.Size = UDim2.new(1, -20, 0, 25)
        bg.Position = UDim2.new(0, 10, 0, yPos)
        bg.BackgroundTransparency = 1
        bg.Parent = parent

        local box = Instance.new("TextButton")
        box.Size = UDim2.new(0, 20, 0, 20)
        box.Position = UDim2.new(0, 0, 0.5, -10)
        box.BackgroundColor3 = getter() and Color3.fromRGB(0, 255, 0) or Color3.fromRGB(60, 60, 60)
        box.Text = ""
        box.Parent = bg

        local boxCorner = Instance.new("UICorner")
        boxCorner.CornerRadius = UDim.new(0, 4)
        boxCorner.Parent = box

        local label = Instance.new("TextLabel")
        label.Size = UDim2.new(1, -30, 1, 0)
        label.Position = UDim2.new(0, 30, 0, 0)
        label.BackgroundTransparency = 1
        label.Text = text
        label.TextColor3 = Color3.new(1, 1, 1)
        label.TextXAlignment = Enum.TextXAlignment.Left
        label.Font = Enum.Font.SourceSans
        label.TextSize = 16
        label.Parent = bg

        box.MouseButton1Click:Connect(function()
            local new = not getter()
            setter(new)
            box.BackgroundColor3 = new and Color3.fromRGB(0, 255, 0) or Color3.fromRGB(60, 60, 60)
        end)
    end

    local function CreateSlider(parent, text, yPos, getter, setter, min, max, format)
        local bg = Instance.new("Frame")
        bg.Size = UDim2.new(1, -20, 0, 40)
        bg.Position = UDim2.new(0, 10, 0, yPos)
        bg.BackgroundTransparency = 1
        bg.Parent = parent

        local label = Instance.new("TextLabel")
        label.Size = UDim2.new(1, 0, 0, 20)
        label.BackgroundTransparency = 1
        label.Text = text .. ": " .. string.format(format, getter())
        label.TextColor3 = Color3.new(1, 1, 1)
        label.Font = Enum.Font.SourceSans
        label.TextSize = 16
        label.Parent = bg

        local sliderBg = Instance.new("Frame")
        sliderBg.Size = UDim2.new(1, 0, 0, 10)
        sliderBg.Position = UDim2.new(0, 0, 0, 25)
        sliderBg.BackgroundColor3 = Color3.fromRGB(80, 80, 80)
        sliderBg.Parent = bg

        local sliderCorner = Instance.new("UICorner")
        sliderCorner.CornerRadius = UDim.new(0, 4)
        sliderCorner.Parent = sliderBg

        local fill = Instance.new("Frame")
        fill.Size = UDim2.new((getter() - min) / (max - min), 0, 1, 0)
        fill.BackgroundColor3 = Color3.fromRGB(0, 150, 255)
        fill.Parent = sliderBg

        local fillCorner = Instance.new("UICorner")
        fillCorner.CornerRadius = UDim.new(0, 4)
        fillCorner.Parent = fill

        local dragging = false
        fill.InputBegan:Connect(function(input)
            if input.UserInputType == Enum.UserInputType.MouseButton1 then
                dragging = true
            end
        end)

        UserInputService.InputEnded:Connect(function(input)
            if input.UserInputType == Enum.UserInputType.MouseButton1 then
                dragging = false
            end
        end)

        RunService.RenderStepped:Connect(function()
            if dragging then
                local mousePos = UserInputService:GetMouseLocation()
                local absX, absY = sliderBg.AbsolutePosition.X, sliderBg.AbsolutePosition.Y
                local absSizeX = sliderBg.AbsoluteSize.X
                local relativeX = math.clamp(mousePos.X - absX, 0, absSizeX)
                local percent = relativeX / absSizeX
                local value = min + (max - min) * percent
                setter(value)
                fill.Size = UDim2.new(percent, 0, 1, 0)
                label.Text = text .. ": " .. string.format(format, value)
            end
        end)
    end

    local function CreateDropdown(parent, text, yPos, options, getter, setter)
        local bg = Instance.new("Frame")
        bg.Size = UDim2.new(1, -20, 0, 30)
        bg.Position = UDim2.new(0, 10, 0, yPos)
        bg.BackgroundTransparency = 1
        bg.Parent = parent

        local label = Instance.new("TextLabel")
        label.Size = UDim2.new(0, 80, 1, 0)
        label.BackgroundTransparency = 1
        label.Text = text .. ":"
        label.TextColor3 = Color3.new(1, 1, 1)
        label.TextXAlignment = Enum.TextXAlignment.Left
        label.Font = Enum.Font.SourceSans
        label.TextSize = 16
        label.Parent = bg

        local button = Instance.new("TextButton")
        button.Size = UDim2.new(1, -90, 0, 25)
        button.Position = UDim2.new(0, 85, 0.5, -12.5)
        button.BackgroundColor3 = Color3.fromRGB(60, 60, 60)
        button.Text = getter()
        button.TextColor3 = Color3.new(1, 1, 1)
        button.Font = Enum.Font.SourceSans
        button.TextSize = 16
        button.Parent = bg

        local btnCorner = Instance.new("UICorner")
        btnCorner.CornerRadius = UDim.new(0, 4)
        btnCorner.Parent = button

        local frame = Instance.new("Frame")
        frame.Size = UDim2.new(1, 0, 0, #options * 25)
        frame.Position = UDim2.new(0, 0, 0, 30)
        frame.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
        frame.BackgroundTransparency = 0.1
        frame.Visible = false
        frame.Parent = bg

        local frmCorner = Instance.new("UICorner")
        frmCorner.CornerRadius = UDim.new(0, 4)
        frmCorner.Parent = frame

        for i, opt in ipairs(options) do
            local optBtn = Instance.new("TextButton")
            optBtn.Size = UDim2.new(1, 0, 0, 25)
            optBtn.Position = UDim2.new(0, 0, 0, (i-1)*25)
            optBtn.BackgroundColor3 = Color3.fromRGB(50, 50, 50)
            optBtn.Text = opt
            optBtn.TextColor3 = Color3.new(1, 1, 1)
            optBtn.Font = Enum.Font.SourceSans
            optBtn.TextSize = 16
            optBtn.Parent = frame

            optBtn.MouseButton1Click:Connect(function()
                setter(opt)
                button.Text = opt
                frame.Visible = false
            end)
        end

        button.MouseButton1Click:Connect(function()
            frame.Visible = not frame.Visible
        end)
    end

    -- === ПОСТРОЕНИЕ МЕНЮ ===
    CreateCheckbox(MainFrame, "ESP Enabled", yPos, 
        function() return Settings.ESP_Enabled end,
        function(v) Settings.ESP_Enabled = v end)
    yPos = yPos + 35

    CreateSlider(MainFrame, "ESP Transparency", yPos,
        function() return Settings.ESP_Transparency end,
        function(v) Settings.ESP_Transparency = v end,
        0, 1, "%.1f")
    yPos = yPos + 50

    CreateCheckbox(MainFrame, "Aimbot Enabled", yPos,
        function() return Settings.Aimbot_Enabled end,
        function(v) Settings.Aimbot_Enabled = v end)
    yPos = yPos + 35

    CreateDropdown(MainFrame, "Target Mode", yPos,
        {"3D", "FOV"},
        function() return Settings.Aimbot_TargetMode end,
        function(v) Settings.Aimbot_TargetMode = v end)
    yPos = yPos + 40

    CreateSlider(MainFrame, "FOV (FOV mode)", yPos,
        function() return Settings.Aimbot_FOV end,
        function(v) Settings.Aimbot_FOV = v end,
        30, 300, "%.0f")
    yPos = yPos + 50

    CreateCheckbox(MainFrame, "Team Check", yPos,
        function() return Settings.Aimbot_TeamCheck end,
        function(v) Settings.Aimbot_TeamCheck = v end)
    yPos = yPos + 35

    CreateCheckbox(MainFrame, "Wallbang", yPos,
        function() return Settings.Aimbot_Wallbang end,
        function(v) Settings.Aimbot_Wallbang = v end)
    yPos = yPos + 35

    CreateCheckbox(MainFrame, "No Recoil", yPos,
        function() return Settings.Aimbot_NoRecoil end,
        function(v) Settings.Aimbot_NoRecoil = v end)
    yPos = yPos + 35

    CreateCheckbox(MainFrame, "Rapid Fire", yPos,
        function() return Settings.Aimbot_RapidFire end,
        function(v) Settings.Aimbot_RapidFire = v end)
    yPos = yPos + 35

    CreateSlider(MainFrame, "Rapid Fire Delay", yPos,
        function() return Settings.Aimbot_RapidFireDelay end,
        function(v) Settings.Aimbot_RapidFireDelay = v end,
        0.01, 0.2, "%.2fs")
    yPos = yPos + 50

    CreateCheckbox(MainFrame, "Auto Fire", yPos,
        function() return Settings.Aimbot_AutoFire end,
        function(v) Settings.Aimbot_AutoFire = v end)
    yPos = yPos + 35

    CreateCheckbox(MainFrame, "Silent Aim", yPos,
        function() return Settings.Aimbot_SilentAim end,
        function(v) Settings.Aimbot_SilentAim = v end)
    yPos = yPos + 35

    -- Fast Bullets
    CreateCheckbox(MainFrame, "Fast Bullets", yPos,
        function() return Settings.FastBullets_Enabled end,
        function(v) Settings.FastBullets_Enabled = v end)
    yPos = yPos + 35

    CreateSlider(MainFrame, "Bullet Speed Multiplier", yPos,
        function() return Settings.FastBullets_Multiplier end,
        function(v) Settings.FastBullets_Multiplier = v end,
        2, 20, "%.0fx")
    yPos = yPos + 50

    local RefreshBtn = Instance.new("TextButton")
    RefreshBtn.Size = UDim2.new(1, -20, 0, 30)
    RefreshBtn.Position = UDim2.new(0, 10, 0, yPos)
    RefreshBtn.BackgroundColor3 = Color3.fromRGB(0, 100, 200)
    RefreshBtn.Text = "REFRESH ESP (3D MODE)"
    RefreshBtn.TextColor3 = Color3.new(1, 1, 1)
    RefreshBtn.Font = Enum.Font.SourceSansBold
    RefreshBtn.TextSize = 16
    RefreshBtn.Parent = MainFrame

    local BtnCorner = Instance.new("UICorner")
    BtnCorner.CornerRadius = UDim.new(0, 6)
    BtnCorner.Parent = RefreshBtn

    RefreshBtn.MouseButton1Click:Connect(function()
        if not DrawingSupported then
            RefreshAllESP()
        end
    end)
end

-- ========== ЗАПУСК ==========
CreateMenu()
if not DrawingSupported then
    RefreshAllESP()
end
print("✅ ESP на все части + Aimbot + Fast Bullets + Rapid Fire + No Recoil. Удерживайте ПКМ для наведения.")
