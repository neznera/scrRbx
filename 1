local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local CoreGui = (gethui and gethui()) or game:GetService("CoreGui")

-- Защита CoreGui (если есть)
if syn and syn.protect_gui then
    syn.protect_gui(CoreGui)
elseif protect_gui then
    protect_gui(CoreGui)
end

local LocalPlayer = Players.LocalPlayer
local Camera = workspace.CurrentCamera

-- ===== НАСТРОЙКИ =====
local Settings = {
    ESP_Enabled = true,
    ESP_Transparency = 0.4,
    ESP_Color = Color3.fromRGB(255, 255, 0),

    Aimbot_Enabled = true,
    Aimbot_Key = Enum.UserInputType.MouseButton2,
    Aimbot_TeamCheck = true,
    Aimbot_AutoFire = true,
    Aimbot_RapidFireDelay = 0.07,
}

-- ===== ПЕРЕМЕННЫЕ =====
local ESP_Cache = setmetatable({}, {__mode = "v"})
local IsKeyHolding = false
local AimTarget = nil
local LastShotTime = 0
local TargetUpdateRate = 0.15  -- обновление цели каждые 0.15 сек
local LastTargetUpdate = 0

-- ===== СЛУЧАЙНЫЕ ИМЕНА =====
local function randomString(len)
    local str = ""
    for i = 1, len do
        str = str .. string.char(math.random(65, 90))
    end
    return str
end

-- ===== ESP =====
function CreateESP(p)
    if not Settings.ESP_Enabled then return end
    local char = p.Character
    if not char then return end
    local hum = char:FindFirstChild("Humanoid")
    if not hum or hum.Health <= 0 then return end

    local container = Instance.new("Folder")
    container.Name = randomString(12)
    container.Parent = CoreGui
    if syn and syn.protect_gui then syn.protect_gui(container) elseif protect_gui then protect_gui(container) end

    -- Рамки на все части
    for _, part in pairs(char:GetChildren()) do
        if part:IsA("BasePart") and part.Transparency < 1 then
            local box = Instance.new("BoxHandleAdornment")
            box.Name = randomString(8)
            box.Adornee = part
            box.AlwaysOnTop = true
            box.ZIndex = 10
            box.Size = part.Size * 1.15
            box.Transparency = Settings.ESP_Transparency
            box.Color = BrickColor.new(Settings.ESP_Color)
            box.Parent = container
        end
    end

    ESP_Cache[p] = {Container = container}
end

function RemoveESP(p)
    if ESP_Cache[p] and ESP_Cache[p].Container then
        ESP_Cache[p].Container:Destroy()
        ESP_Cache[p] = nil
    end
end

function RefreshAllESP()
    for p, _ in pairs(ESP_Cache) do RemoveESP(p) end
    for _, p in pairs(Players:GetPlayers()) do
        if p ~= LocalPlayer then CreateESP(p) end
    end
end

-- ===== ОБНОВЛЕНИЕ ПРОЗРАЧНОСТИ =====
function UpdateESPTransparency()
    for p, data in pairs(ESP_Cache) do
        if data.Container then
            for _, child in pairs(data.Container:GetChildren()) do
                if child:IsA("BoxHandleAdornment") then
                    child.Transparency = Settings.ESP_Transparency
                end
            end
        end
    end
end

-- ===== СОБЫТИЯ ИГРОКОВ =====
local function onCharacterAdded(p, char)
    if p == LocalPlayer then return end
    RemoveESP(p)
    CreateESP(p)
end

for _, p in pairs(Players:GetPlayers()) do
    if p ~= LocalPlayer then
        if p.Character then CreateESP(p) end
        p.CharacterAdded:Connect(function(char) onCharacterAdded(p, char) end)
        p.CharacterRemoving:Connect(function() RemoveESP(p) end)
    end
end

Players.PlayerAdded:Connect(function(p)
    if p == LocalPlayer then return end
    p.CharacterAdded:Connect(function(char) onCharacterAdded(p, char) end)
    p.CharacterRemoving:Connect(function() RemoveESP(p) end)
end)

Players.PlayerRemoving:Connect(RemoveESP)

-- ===== AIMBOT (ТОЛЬКО БЛИЖАЙШИЙ, С ПРОВЕРКОЙ ВИДИМОСТИ) =====
local function IsTeamMate(p)
    if not Settings.Aimbot_TeamCheck then return false end
    if not p.Team or not LocalPlayer.Team then return false end
    return p.Team == LocalPlayer.Team
end

local function IsVisible(character)
    local head = character:FindFirstChild("Head")
    if not head then return false end
    local origin = Camera.CFrame.Position
    local direction = head.Position - origin
    local ray = Ray.new(origin, direction.Unit * direction.Magnitude)
    local hit = workspace:FindPartOnRayWithIgnoreList(ray, {LocalPlayer.Character, Camera})
    return hit and hit:IsDescendantOf(character)
end

-- Поиск ближайшего врага (3D дистанция) — вызывается не каждый кадр!
local function GetClosestEnemy()
    local closest = nil
    local closestDist = math.huge

    for _, p in pairs(Players:GetPlayers()) do
        if p ~= LocalPlayer and p.Character and p.Character:FindFirstChild("Humanoid") and p.Character.Humanoid.Health > 0 then
            if not IsTeamMate(p) and IsVisible(p.Character) then
                local head = p.Character:FindFirstChild("Head")
                if head then
                    local myHead = LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("Head")
                    if myHead then
                        local dist = (head.Position - myHead.Position).Magnitude
                        if dist < closestDist then
                            closestDist = dist
                            closest = p
                        end
                    end
                end
            end
        end
    end
    return closest
end

-- ===== УПРАВЛЕНИЕ КЛАВИШЕЙ =====
UserInputService.InputBegan:Connect(function(input, gp)
    if not gp and input.UserInputType == Settings.Aimbot_Key then
        IsKeyHolding = true
    end
end)

UserInputService.InputEnded:Connect(function(input, gp)
    if input.UserInputType == Settings.Aimbot_Key then
        IsKeyHolding = false
    end
end)

-- ===== ГЛАВНЫЙ ЦИКЛ (НЕ НАГРУЖАЕТ) =====
RunService.RenderStepped:Connect(function()
    -- Только аимбот по удержанию клавиши
    if Settings.Aimbot_Enabled and IsKeyHolding then
        local now = tick()
        -- Обновляем цель раз в TargetUpdateRate секунд (не каждый кадр!)
        if now - LastTargetUpdate >= TargetUpdateRate then
            AimTarget = GetClosestEnemy()
            LastTargetUpdate = now
        end

        -- Если есть цель — наводим и стреляем
        if AimTarget and AimTarget.Character and AimTarget.Character:FindFirstChild("Head") then
            local head = AimTarget.Character.Head
            local vector, onScreen = Camera:WorldToViewportPoint(head.Position)
            if onScreen then
                local targetPos = Vector2.new(vector.X, vector.Y)
                local currentPos = UserInputService:GetMouseLocation()
                local delta = targetPos - currentPos

                -- Двигаем мышь (мгновенно, без Lerp)
                if mousemoverel then
                    mousemoverel(delta.X, delta.Y)
                elseif syn and syn.input then
                    syn.input.MouseMove(delta.X, delta.Y)
                end

                -- Автоогонь
                if Settings.Aimbot_AutoFire then
                    if now - LastShotTime >= Settings.Aimbot_RapidFireDelay then
                        if mousemoverel then
                            mouse1click()
                        elseif syn and syn.input then
                            syn.input.Mouse1Click()
                        end
                        LastShotTime = now
                    end
                end
            end
        end
    else
        AimTarget = nil
    end
end)

-- ===== ЗАПУСК =====
RefreshAllESP()
print("✅ Оптимизированная ESP + Aimbot. Удерживайте ПКМ для наведения на ближайшего врага.")
