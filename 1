--[[
    ESP + Legit Aimbot (U) + Fly (T)
    - ESP: враги красные, союзники зелёные (опционально)
    - Aimbot: плавное наведение на голову ближайшего врага при удержании U
    - Fly: включение/выключение по клавише T, управление WASD + Пробел/Ctrl
]]

local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local CoreGui = (gethui and gethui()) or game:GetService("CoreGui")

if syn and syn.protect_gui then syn.protect_gui(CoreGui) elseif protect_gui then protect_gui(CoreGui) end

local LocalPlayer = Players.LocalPlayer
local Camera = workspace.CurrentCamera

-- ========== НАСТРОЙКИ ==========
local Settings = {
    -- ESP
    ESP_Enabled = true,
    TeamCheck = true,          -- true = союзники зелёные, враги красные
    
    -- Aimbot
    Aimbot_Enabled = true,
    Aimbot_Key = Enum.KeyCode.U,  -- клавиша активации аима (U)
    FOV = 120,                     -- радиус в пикселях
    Smoothness = 10,               -- чем больше, тем плавнее (1 = мгновенно)
    
    -- Fly
    Fly_Enabled = false,
    Fly_Key = Enum.KeyCode.T,      -- клавиша включения/выключения полёта
    Fly_Speed = 50,
}

-- ========== ПЕРЕМЕННЫЕ ==========
local ESP_Folder = Instance.new("Folder")
ESP_Folder.Name = "ESP_Container"
ESP_Folder.Parent = CoreGui

local IsAiming = false

-- Fly переменные
local flyBodyVelocity = nil
local flyBodyGyro = nil
local flyConnection = nil

-- ========== ESP ==========
local function GetTeamColor(player)
    if player == LocalPlayer then return nil end
    if Settings.TeamCheck then
        if not player.Team or not LocalPlayer.Team then
            return BrickColor.new("Bright red") -- если нет команд – все красные
        end
        if player.Team == LocalPlayer.Team then
            return BrickColor.new("Bright green") -- союзники
        else
            return BrickColor.new("Bright red")   -- враги
        end
    else
        -- если TeamCheck выключен – все красные (кроме себя)
        return BrickColor.new("Bright red")
    end
end

RunService.RenderStepped:Connect(function()
    if not Settings.ESP_Enabled then
        for _, child in pairs(ESP_Folder:GetChildren()) do
            child:Destroy()
        end
        return
    end

    -- Удаляем старые рамки
    for _, child in pairs(ESP_Folder:GetChildren()) do
        child:Destroy()
    end

    for _, player in pairs(Players:GetPlayers()) do
        if player ~= LocalPlayer then
            local color = GetTeamColor(player)
            if color then
                local char = player.Character
                if char then
                    local hum = char:FindFirstChild("Humanoid")
                    if hum and hum.Health > 0 then
                        for _, part in pairs(char:GetDescendants()) do
                            if part:IsA("BasePart") and part.Transparency < 1 then
                                local box = Instance.new("BoxHandleAdornment")
                                box.Name = part.Name
                                box.Adornee = part
                                box.AlwaysOnTop = true
                                box.ZIndex = 10
                                box.Size = part.Size * 1.05
                                box.Transparency = 0.3
                                box.Color = color
                                box.Parent = ESP_Folder
                            end
                        end
                    end
                end
            end
        end
    end
end)

-- ========== AIMBOT ==========
local function IsEnemy(player)
    if player == LocalPlayer then return false end
    if Settings.TeamCheck then
        if not player.Team or not LocalPlayer.Team then return true end
        return player.Team ~= LocalPlayer.Team
    end
    return true
end

local function GetTarget()
    if not Settings.Aimbot_Enabled then return nil end
    local mousePos = UserInputService:GetMouseLocation()
    local closestPlayer = nil
    local closestDist = Settings.FOV
    for _, player in pairs(Players:GetPlayers()) do
        if IsEnemy(player) then
            local char = player.Character
            if char then
                local hum = char:FindFirstChild("Humanoid")
                if hum and hum.Health > 0 then
                    local head = char:FindFirstChild("Head")
                    if head then
                        local vec, onScreen = Camera:WorldToViewportPoint(head.Position)
                        if onScreen then
                            local dist = (Vector2.new(vec.X, vec.Y) - mousePos).Magnitude
                            if dist < closestDist then
                                closestDist = dist
                                closestPlayer = player
                            end
                        end
                    end
                end
            end
        end
    end
    return closestPlayer
end

local function MoveMouseSmooth(targetX, targetY)
    local current = UserInputService:GetMouseLocation()
    local deltaX = targetX - current.X
    local deltaY = targetY - current.Y
    if math.abs(deltaX) < 0.5 and math.abs(deltaY) < 0.5 then return end

    local smooth = math.max(1, Settings.Smoothness)
    local moveX = deltaX / smooth
    local moveY = deltaY / smooth

    if mousemoverel then
        mousemoverel(moveX, moveY)
    elseif syn and syn.input then
        syn.input.MouseMove(moveX, moveY)
    elseif VirtualInputManager then
        VirtualInputManager:SendMouseMoveEvent(moveX, moveY, false)
    end
end

UserInputService.InputBegan:Connect(function(input, gp)
    if gp then return end
    if input.KeyCode == Settings.Aimbot_Key then
        IsAiming = true
    elseif input.KeyCode == Settings.Fly_Key then
        ToggleFly()
    end
end)

UserInputService.InputEnded:Connect(function(input)
    if input.KeyCode == Settings.Aimbot_Key then
        IsAiming = false
    end
end)

RunService.RenderStepped:Connect(function()
    if IsAiming and Settings.Aimbot_Enabled then
        local target = GetTarget()
        if target and target.Character then
            local head = target.Character:FindFirstChild("Head")
            if head then
                local vec, onScreen = Camera:WorldToViewportPoint(head.Position)
                if onScreen then
                    MoveMouseSmooth(vec.X, vec.Y)
                end
            end
        end
    end
end)

-- ========== FLY ==========
local function EnableFly()
    local char = LocalPlayer.Character
    if not char then return end
    local root = char:FindFirstChild("HumanoidRootPart")
    local hum = char:FindFirstChild("Humanoid")
    if not root or not hum then return end

    hum.PlatformStand = true

    flyBodyVelocity = Instance.new("BodyVelocity")
    flyBodyVelocity.MaxForce = Vector3.new(4000, 4000, 4000)
    flyBodyVelocity.Velocity = Vector3.new(0, 0, 0)
    flyBodyVelocity.Parent = root

    flyBodyGyro = Instance.new("BodyGyro")
    flyBodyGyro.MaxTorque = Vector3.new(4000, 4000, 4000)
    flyBodyGyro.P = 1000
    flyBodyGyro.D = 200
    flyBodyGyro.CFrame = root.CFrame
    flyBodyGyro.Parent = root

    Settings.Fly_Enabled = true
end

local function DisableFly()
    Settings.Fly_Enabled = false
    if flyBodyVelocity then flyBodyVelocity:Destroy() flyBodyVelocity = nil end
    if flyBodyGyro then flyBodyGyro:Destroy() flyBodyGyro = nil end
    local char = LocalPlayer.Character
    if char then
        local hum = char:FindFirstChild("Humanoid")
        if hum then hum.PlatformStand = false end
    end
end

local function ToggleFly()
    if Settings.Fly_Enabled then
        DisableFly()
    else
        EnableFly()
    end
end

-- Цикл управления полётом
flyConnection = RunService.Heartbeat:Connect(function()
    if Settings.Fly_Enabled and LocalPlayer.Character then
        local root = LocalPlayer.Character:FindFirstChild("HumanoidRootPart")
        if root and flyBodyVelocity and flyBodyGyro then
            local move = Vector3.new()
            if UserInputService:IsKeyDown(Enum.KeyCode.W) then
                move = move + Camera.CFrame.LookVector
            end
            if UserInputService:IsKeyDown(Enum.KeyCode.S) then
                move = move - Camera.CFrame.LookVector
            end
            if UserInputService:IsKeyDown(Enum.KeyCode.A) then
                move = move - Camera.CFrame.RightVector
            end
            if UserInputService:IsKeyDown(Enum.KeyCode.D) then
                move = move + Camera.CFrame.RightVector
            end
            if UserInputService:IsKeyDown(Enum.KeyCode.Space) then
                move = move + Vector3.new(0, 1, 0)
            end
            if UserInputService:IsKeyDown(Enum.KeyCode.LeftControl) then
                move = move - Vector3.new(0, 1, 0)
            end
            if move.Magnitude > 0 then
                move = move.Unit * Settings.Fly_Speed
            end
            flyBodyVelocity.Velocity = move
            flyBodyGyro.CFrame = CFrame.lookAt(root.Position, root.Position + Camera.CFrame.LookVector)
        end
    end
end)

-- Отключаем полёт при респавне
LocalPlayer.CharacterAdded:Connect(function()
    if Settings.Fly_Enabled then
        DisableFly()
    end
end)

-- ========== ЗАПУСК ==========
print("✅ ESP + Legit Aimbot + Fly загружены. Удерживайте U для аима, T для полёта.")
print("Настройки: TeamCheck =", Settings.TeamCheck, "FOV =", Settings.FOV, "Smoothness =", Settings.Smoothness, "Fly Speed =", Settings.Fly_Speed)
