--[[
    ESP + Legit Aimbot (клавиша U)
    - ESP: враги красные, союзники зелёные
    - Aimbot: плавное наведение на голову ближайшего врага при удержании U
    - Настройки: TeamCheck, FOV, Smoothness
]]

local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local CoreGui = (gethui and gethui()) or game:GetService("CoreGui")

if syn and syn.protect_gui then syn.protect_gui(CoreGui) elseif protect_gui then protect_gui(CoreGui) end

local LocalPlayer = Players.LocalPlayer
local Camera = workspace.CurrentCamera

-- ========== НАСТРОЙКИ ==========
local Settings = {
    -- ESP
    ESP_Enabled = true,
    TeamCheck = true,          -- true = союзники зелёные, враги красные
    
    -- Aimbot
    Aimbot_Enabled = true,
    Aimbot_Key = Enum.KeyCode.U,  -- клавиша активации (U)
    FOV = 120,                     -- радиус в пикселях
    Smoothness = 10,               -- чем больше, тем плавнее (1 = мгновенно)
}

-- ========== ESP ==========
local ESP_Folder = Instance.new("Folder")
ESP_Folder.Name = "ESP_Container"
ESP_Folder.Parent = CoreGui

local function GetTeamColor(player)
    if player == LocalPlayer then return nil end
    if Settings.TeamCheck then
        if not player.Team or not LocalPlayer.Team then
            return BrickColor.new("Bright red") -- если нет команд – все красные
        end
        if player.Team == LocalPlayer.Team then
            return BrickColor.new("Bright green") -- союзники
        else
            return BrickColor.new("Bright red")   -- враги
        end
    else
        -- если TeamCheck выключен – все красные (кроме себя)
        return BrickColor.new("Bright red")
    end
end

RunService.RenderStepped:Connect(function()
    if not Settings.ESP_Enabled then
        for _, child in pairs(ESP_Folder:GetChildren()) do
            child:Destroy()
        end
        return
    end

    -- Удаляем старые рамки
    for _, child in pairs(ESP_Folder:GetChildren()) do
        child:Destroy()
    end

    for _, player in pairs(Players:GetPlayers()) do
        if player ~= LocalPlayer then
            local color = GetTeamColor(player)
            if color then
                local char = player.Character
                if char then
                    local hum = char:FindFirstChild("Humanoid")
                    if hum and hum.Health > 0 then
                        for _, part in pairs(char:GetDescendants()) do
                            if part:IsA("BasePart") and part.Transparency < 1 then
                                local box = Instance.new("BoxHandleAdornment")
                                box.Name = part.Name
                                box.Adornee = part
                                box.AlwaysOnTop = true
                                box.ZIndex = 10
                                box.Size = part.Size * 1.05
                                box.Transparency = 0.3
                                box.Color = color
                                box.Parent = ESP_Folder
                            end
                        end
                    end
                end
            end
        end
    end
end)

-- ========== AIMBOT ==========
local IsAiming = false

local function IsEnemy(player)
    if player == LocalPlayer then return false end
    if Settings.TeamCheck then
        if not player.Team or not LocalPlayer.Team then return true end
        return player.Team ~= LocalPlayer.Team
    end
    return true
end

local function GetTarget()
    if not Settings.Aimbot_Enabled then return nil end
    local mousePos = UserInputService:GetMouseLocation()
    local closestPlayer = nil
    local closestDist = Settings.FOV
    for _, player in pairs(Players:GetPlayers()) do
        if IsEnemy(player) then
            local char = player.Character
            if char then
                local hum = char:FindFirstChild("Humanoid")
                if hum and hum.Health > 0 then
                    local head = char:FindFirstChild("Head")
                    if head then
                        local vec, onScreen = Camera:WorldToViewportPoint(head.Position)
                        if onScreen then
                            local dist = (Vector2.new(vec.X, vec.Y) - mousePos).Magnitude
                            if dist < closestDist then
                                closestDist = dist
                                closestPlayer = player
                            end
                        end
                    end
                end
            end
        end
    end
    return closestPlayer
end

local function MoveMouseSmooth(targetX, targetY)
    local current = UserInputService:GetMouseLocation()
    local deltaX = targetX - current.X
    local deltaY = targetY - current.Y
    if math.abs(deltaX) < 0.5 and math.abs(deltaY) < 0.5 then return end

    local smooth = math.max(1, Settings.Smoothness)
    local moveX = deltaX / smooth
    local moveY = deltaY / smooth

    if mousemoverel then
        mousemoverel(moveX, moveY)
    elseif syn and syn.input then
        syn.input.MouseMove(moveX, moveY)
    elseif VirtualInputManager then
        VirtualInputManager:SendMouseMoveEvent(moveX, moveY, false)
    end
end

UserInputService.InputBegan:Connect(function(input, gp)
    if gp then return end
    if input.KeyCode == Settings.Aimbot_Key then
        IsAiming = true
    end
end)

UserInputService.InputEnded:Connect(function(input)
    if input.KeyCode == Settings.Aimbot_Key then
        IsAiming = false
    end
end)

RunService.RenderStepped:Connect(function()
    if IsAiming and Settings.Aimbot_Enabled then
        local target = GetTarget()
        if target and target.Character then
            local head = target.Character:FindFirstChild("Head")
            if head then
                local vec, onScreen = Camera:WorldToViewportPoint(head.Position)
                if onScreen then
                    MoveMouseSmooth(vec.X, vec.Y)
                end
            end
        end
    end
end)

-- ========== ЗАПУСК ==========
print("✅ ESP + Legit Aimbot загружены. Удерживайте U для наведения.")
print("Настройки: TeamCheck =", Settings.TeamCheck, "FOV =", Settings.FOV, "Smoothness =", Settings.Smoothness)
