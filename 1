local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local CoreGui = (gethui and gethui()) or game:GetService("CoreGui")

-- Защита CoreGui
if syn and syn.protect_gui then
    syn.protect_gui(CoreGui)
elseif protect_gui then
    protect_gui(CoreGui)
end

local LocalPlayer = Players.LocalPlayer
local Camera = workspace.CurrentCamera

-- ===== НАСТРОЙКИ (можно менять) =====
local TEAM_CHECK = true          -- true = только враги, false = все кроме себя
local AIM_KEY = Enum.UserInputType.MouseButton2  -- правая кнопка
local ESP_COLOR = Color3.fromRGB(255, 255, 0)    -- жёлтый

-- ===== ESP: жёлтый круг на голове =====
local ESP_Cache = setmetatable({}, {__mode = "v"})

local function IsEnemy(p)
    if p == LocalPlayer then return false end
    if not TEAM_CHECK then return true end
    if not p.Team or not LocalPlayer.Team then return true end
    return p.Team ~= LocalPlayer.Team
end

local function CreateESP(p)
    if not IsEnemy(p) then return end
    local char = p.Character
    if not char then return end
    local head = char:FindFirstChild("Head")
    local hum = char:FindFirstChild("Humanoid")
    if not head or not hum or hum.Health <= 0 then return end

    -- Удалить старый
    if ESP_Cache[p] then
        ESP_Cache[p]:Destroy()
        ESP_Cache[p] = nil
    end

    local billboard = Instance.new("BillboardGui")
    billboard.Name = "ESP_" .. p.Name
    billboard.Adornee = head
    billboard.Size = UDim2.new(1.5, 0, 1.5, 0)
    billboard.StudsOffset = Vector3.new(0, 0.5, 0)
    billboard.AlwaysOnTop = true
    billboard.LightInfluence = 0
    billboard.Parent = CoreGui

    local circle = Instance.new("ImageLabel")
    circle.Size = UDim2.new(1, 0, 1, 0)
    circle.BackgroundTransparency = 1
    circle.Image = "rbxasset://textures/ui/GuiImagePlaceholder.png"
    circle.ImageColor3 = ESP_COLOR
    circle.ImageTransparency = 0.3
    circle.ScaleType = Enum.ScaleType.Fit
    circle.Parent = billboard

    ESP_Cache[p] = billboard
end

local function RemoveESP(p)
    if ESP_Cache[p] then
        ESP_Cache[p]:Destroy()
        ESP_Cache[p] = nil
    end
end

-- События игроков
local function onCharacterAdded(p)
    if p == LocalPlayer then return end
    task.wait(0.1)
    CreateESP(p)
end

for _, p in pairs(Players:GetPlayers()) do
    if p ~= LocalPlayer then
        if p.Character then CreateESP(p) end
        p.CharacterAdded:Connect(onCharacterAdded)
        p.CharacterRemoving:Connect(function() RemoveESP(p) end)
    end
end

Players.PlayerAdded:Connect(function(p)
    if p == LocalPlayer then return end
    p.CharacterAdded:Connect(onCharacterAdded)
    p.CharacterRemoving:Connect(function() RemoveESP(p) end)
end)

Players.PlayerRemoving:Connect(RemoveESP)

-- ===== AIMBOT: мгновенное наведение на голову =====
local function IsTeamMate(p)
    if not TEAM_CHECK then return false end
    if not p.Team or not LocalPlayer.Team then return false end
    return p.Team == LocalPlayer.Team
end

local function IsVisible(character)
    local head = character:FindFirstChild("Head")
    if not head then return false end
    local ray = Ray.new(Camera.CFrame.Position, (head.Position - Camera.CFrame.Position).Unit * 1000)
    local hit = workspace:FindPartOnRayWithIgnoreList(ray, {LocalPlayer.Character, Camera})
    return hit and hit:IsDescendantOf(character)
end

local function GetClosestEnemy()
    local closest = nil
    local closestDist = math.huge
    local myHead = LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("Head")
    if not myHead then return nil end

    for _, p in pairs(Players:GetPlayers()) do
        if p ~= LocalPlayer and p.Character and p.Character:FindFirstChild("Humanoid") and p.Character.Humanoid.Health > 0 then
            if not IsTeamMate(p) and IsVisible(p.Character) then
                local head = p.Character:FindFirstChild("Head")
                if head then
                    local dist = (head.Position - myHead.Position).Magnitude
                    if dist < closestDist then
                        closestDist = dist
                        closest = p
                    end
                end
            end
        end
    end
    return closest
end

-- Перемещение мыши
local function MoveMouse(deltaX, deltaY)
    if mousemoverel then
        mousemoverel(deltaX, deltaY)
    elseif syn and syn.input then
        syn.input.MouseMove(deltaX, deltaY)
    elseif VirtualInputManager then
        VirtualInputManager:SendMouseMoveEvent(deltaX, deltaY, false)
    end
end

-- Управление клавишей
local isAiming = false
UserInputService.InputBegan:Connect(function(input, gp)
    if not gp and input.UserInputType == AIM_KEY then
        isAiming = true
    end
end)
UserInputService.InputEnded:Connect(function(input)
    if input.UserInputType == AIM_KEY then
        isAiming = false
    end
end)

-- Главный цикл
RunService.RenderStepped:Connect(function()
    if isAiming then
        local target = GetClosestEnemy()
        if target and target.Character and target.Character:FindFirstChild("Head") then
            local head = target.Character.Head
            local vector, onScreen = Camera:WorldToViewportPoint(head.Position)
            if onScreen then
                local targetPos = Vector2.new(vector.X, vector.Y)
                local mousePos = UserInputService:GetMouseLocation()
                local delta = targetPos - mousePos
                if delta.Magnitude > 0.5 then
                    MoveMouse(delta.X, delta.Y)
                end
            end
        end
    end
end)

print("✅ ESP + Aimbot загружены. Удерживайте ПКМ для наведения на голову.")
