local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local CoreGui = (gethui and gethui()) or game:GetService("CoreGui")

-- Защита CoreGui
if syn and syn.protect_gui then
    syn.protect_gui(CoreGui)
elseif protect_gui then
    protect_gui(CoreGui)
end

local LocalPlayer = Players.LocalPlayer
local Camera = workspace.CurrentCamera

-- ===== СЛУЧАЙНЫЕ ИМЕНА =====
local function randomString(len)
    local str = ""
    for i = 1, len do
        str = str .. string.char(math.random(65, 90))
    end
    return str
end

-- ===== НАСТРОЙКИ =====
local Settings = {
    FlySpeed = 50,
}

-- ===== ПЕРЕМЕННЫЕ =====
local flyEnabled = false
local flyBV = nil
local flyBG = nil
local flyConnection = nil

-- ===== ФУНКЦИИ FLY =====
local function enableFly()
    local char = LocalPlayer.Character
    if not char then return end
    local root = char:FindFirstChild("HumanoidRootPart")
    local hum = char:FindFirstChild("Humanoid")
    if not root or not hum then return end

    -- Убираем гравитацию через PlatformStand (НЕ детектится как BodyVelocity)
    hum.PlatformStand = true
    hum.WalkSpeed = 16  -- не влияет на полёт, но оставим

    -- BodyVelocity для движения
    flyBV = Instance.new("BodyVelocity")
    flyBV.Name = randomString(12)
    flyBV.MaxForce = Vector3.new(4000, 4000, 4000)
    flyBV.Velocity = Vector3.new(0, 0, 0)
    flyBV.Parent = root

    -- BodyGyro для стабилизации (чтобы не крутило)
    flyBG = Instance.new("BodyGyro")
    flyBG.Name = randomString(12)
    flyBG.MaxTorque = Vector3.new(4000, 4000, 4000)
    flyBG.P = 1000
    flyBG.D = 500
    flyBG.CFrame = root.CFrame
    flyBG.Parent = root

    -- Защита объектов
    if syn and syn.protect_gui then
        syn.protect_gui(flyBV)
        syn.protect_gui(flyBG)
    elseif protect_gui then
        protect_gui(flyBV)
        protect_gui(flyBG)
    end

    flyEnabled = true

    -- Цикл полёта
    flyConnection = RunService.Heartbeat:Connect(function()
        if not flyEnabled or not char or not root then
            disableFly()
            return
        end

        -- Направление от камеры
        local move = Vector3.new()
        if UserInputService:IsKeyDown(Enum.KeyCode.W) then
            move = move + Camera.CFrame.LookVector
        end
        if UserInputService:IsKeyDown(Enum.KeyCode.S) then
            move = move - Camera.CFrame.LookVector
        end
        if UserInputService:IsKeyDown(Enum.KeyCode.A) then
            move = move - Camera.CFrame.RightVector
        end
        if UserInputService:IsKeyDown(Enum.KeyCode.D) then
            move = move + Camera.CFrame.RightVector
        end
        if UserInputService:IsKeyDown(Enum.KeyCode.Space) then
            move = move + Vector3.new(0, 1, 0)
        end
        if UserInputService:IsKeyDown(Enum.KeyCode.LeftControl) then
            move = move - Vector3.new(0, 1, 0)
        end

        if move.Magnitude > 0 then
            move = move.Unit * Settings.FlySpeed
        end

        flyBV.Velocity = move
        flyBG.CFrame = CFrame.lookAt(root.Position, root.Position + Camera.CFrame.LookVector)
    end)
end

local function disableFly()
    flyEnabled = false
    if flyConnection then
        flyConnection:Disconnect()
        flyConnection = nil
    end
    if flyBV then
        flyBV:Destroy()
        flyBV = nil
    end
    if flyBG then
        flyBG:Destroy()
        flyBG = nil
    end
    local char = LocalPlayer.Character
    if char then
        local hum = char:FindFirstChild("Humanoid")
        if hum then
            hum.PlatformStand = false
        end
    end
end

local function toggleFly()
    if flyEnabled then
        disableFly()
    else
        enableFly()
    end
end

-- ===== УПРАВЛЕНИЕ =====
UserInputService.InputBegan:Connect(function(input, gp)
    if not gp and input.KeyCode == Enum.KeyCode.F then
        toggleFly()
    end
end)

-- Отключаем при респавне
LocalPlayer.CharacterAdded:Connect(function()
    if flyEnabled then
        disableFly()
    end
end)

-- ===== МЕНЮ =====
local ScreenGui = Instance.new("ScreenGui")
ScreenGui.Name = randomString(12)
ScreenGui.Parent = CoreGui
if syn and syn.protect_gui then
    syn.protect_gui(ScreenGui)
elseif protect_gui then
    protect_gui(ScreenGui)
end

local MainFrame = Instance.new("Frame")
MainFrame.Size = UDim2.new(0, 300, 0, 160)
MainFrame.Position = UDim2.new(0, 50, 0, 50)
MainFrame.BackgroundColor3 = Color3.fromRGB(25, 25, 25)
MainFrame.BackgroundTransparency = 0.1
MainFrame.Active = true
MainFrame.Draggable = true
MainFrame.Parent = ScreenGui

local UICorner = Instance.new("UICorner")
UICorner.CornerRadius = UDim.new(0, 8)
UICorner.Parent = MainFrame

local Title = Instance.new("TextLabel")
Title.Size = UDim2.new(1, 0, 0, 40)
Title.BackgroundTransparency = 1
Title.Text = "⚡ FLY"
Title.TextColor3 = Color3.fromRGB(100, 200, 255)
Title.Font = Enum.Font.SourceSansBold
Title.TextSize = 24
Title.Parent = MainFrame

-- Статус Fly
local StatusLabel = Instance.new("TextLabel")
StatusLabel.Size = UDim2.new(1, -20, 0, 35)
StatusLabel.Position = UDim2.new(0, 10, 0, 45)
StatusLabel.BackgroundColor3 = Color3.fromRGB(45, 45, 45)
StatusLabel.Text = "FLY: OFF (Press F)"
StatusLabel.TextColor3 = Color3.fromRGB(255, 100, 100)
StatusLabel.Font = Enum.Font.SourceSansBold
StatusLabel.TextSize = 20
StatusLabel.Parent = MainFrame
local StatusCorner = Instance.new("UICorner")
StatusCorner.CornerRadius = UDim.new(0, 6)
StatusCorner.Parent = StatusLabel

-- Слайдер скорости
local SpeedLabel = Instance.new("TextLabel")
SpeedLabel.Size = UDim2.new(1, -20, 0, 25)
SpeedLabel.Position = UDim2.new(0, 10, 0, 95)
SpeedLabel.BackgroundTransparency = 1
SpeedLabel.Text = "Скорость: " .. Settings.FlySpeed
SpeedLabel.TextColor3 = Color3.new(1, 1, 1)
SpeedLabel.Font = Enum.Font.SourceSans
SpeedLabel.TextSize = 18
SpeedLabel.TextXAlignment = Enum.TextXAlignment.Left
SpeedLabel.Parent = MainFrame

local SliderBg = Instance.new("Frame")
SliderBg.Size = UDim2.new(1, -20, 0, 12)
SliderBg.Position = UDim2.new(0, 10, 0, 125)
SliderBg.BackgroundColor3 = Color3.fromRGB(60, 60, 60)
SliderBg.Parent = MainFrame
local SliderCorner = Instance.new("UICorner")
SliderCorner.CornerRadius = UDim.new(0, 6)
SliderCorner.Parent = SliderBg

local SliderFill = Instance.new("Frame")
SliderFill.Size = UDim2.new((Settings.FlySpeed - 20) / 130, 0, 1, 0)
SliderFill.BackgroundColor3 = Color3.fromRGB(0, 200, 255)
SliderFill.Parent = SliderBg
local FillCorner = Instance.new("UICorner")
FillCorner.CornerRadius = UDim.new(0, 6)
FillCorner.Parent = SliderFill

-- Логика слайдера
local dragging = false
SliderFill.InputBegan:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 then
        dragging = true
    end
end)

UserInputService.InputEnded:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 then
        dragging = false
    end
end)

RunService.RenderStepped:Connect(function()
    if dragging then
        local mousePos = UserInputService:GetMouseLocation()
        local absX, absY = SliderBg.AbsolutePosition.X, SliderBg.AbsolutePosition.Y
        local absSizeX = SliderBg.AbsoluteSize.X
        local relativeX = math.clamp(mousePos.X - absX, 0, absSizeX)
        local percent = relativeX / absSizeX
        local value = math.floor(20 + (130 * percent))
        Settings.FlySpeed = math.clamp(value, 20, 150)
        SliderFill.Size = UDim2.new((Settings.FlySpeed - 20) / 130, 0, 1, 0)
        SpeedLabel.Text = "Скорость: " .. Settings.FlySpeed
    end
end)

-- Обновление статуса
RunService.RenderStepped:Connect(function()
    if flyEnabled then
        StatusLabel.Text = "FLY: ON (Press F)"
        StatusLabel.TextColor3 = Color3.fromRGB(100, 255, 100)
        StatusLabel.BackgroundColor3 = Color3.fromRGB(40, 80, 40)
    else
        StatusLabel.Text = "FLY: OFF (Press F)"
        StatusLabel.TextColor3 = Color3.fromRGB(255, 100, 100)
        StatusLabel.BackgroundColor3 = Color3.fromRGB(80, 40, 40)
    end
end)

print("✅ FLY загружен. Нажми F для полёта. Скорость регулируется ползунком.")
